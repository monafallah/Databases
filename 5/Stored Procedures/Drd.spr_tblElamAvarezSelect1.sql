SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [Drd].[spr_tblElamAvarezSelect1] 
	@fieldname nvarchar(50),
	@Value nvarchar(50),
	@Value1 nvarchar(50),
	@h int
AS 
	BEGIN TRAN
	--DECLARE @organ TABLE (id int)
	--;WITH organ as	(
	--SELECT    fldId    
	--FROM            Com.tblOrganization
	--WHERE fldId=@Value1
	--UNION ALL
	--SELECT t.fldId FROM Com.tblOrganization AS t
	--INNER JOIN organ ON t.fldPId=organ.fldId
	-- )
	-- INSERT INTO @organ 
	--		 ( id )
	-- SELECT organ.fldId FROM organ

	declare @t int,@organid int
	if (@h=0) set @h=2147483647
	--set @t=@h 
	--set @organid=@Value1
    --set  @Value=com.fn_TextNormalize(@Value)

	 if (@fieldname=N'')
	 begin

	 --select TOP (@h) * from drd.tblElamAvarez 		ORDER BY fldid desc 
SELECT TOP (@h)  fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
  ,fldNoeShakhs,com.miladitoshamsi(flddate),isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,

 SharhDesc,fldIsExternal,fldDaramadGroupId
 FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli ,
            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
			ELSE N'0'END AS fldStatusFish
			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
			ELSE N'0' end AS fldStatusTaghsit,
		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
			 AS fldStatusTakhfif,
			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			THEN N'2'ELSE '0'END */'0'AS fldStatusKoli,
                  ''AS fldNoeShakhs, fldTarikh,
                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
                      ,isnull((select fldid from drd.tblReplyTaghsit where fldStatusId=(
select fldid from drd.tblStatusTaghsit_Takhfif where fldRequestId=(
select top(1)fldId from drd.tblRequestTaghsit_Takhfif where fldElamAvarezId=Drd.tblElamAvarez.fldid and drd.tblRequestTaghsit_Takhfif.fldId 
not in(select fldRequestTaghsit_TakhfifId from drd.tblEbtal 
where fldRequestTaghsit_TakhfifId=drd.tblRequestTaghsit_Takhfif.fldid)  AND fldRequestType = 1 order by drd.tblRequestTaghsit_Takhfif.fldid desc

) and fldTypeMojavez=1 and fldTypeRequest=1
)),0) fldReplyTaghsitId
                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
FROM     Drd.tblElamAvarez)t
       where   t.fldOrganId=@Value1
		ORDER BY fldid desc 

		end

	else if (@fieldname=N'fldId')
	begin
SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
  ,fldNoeShakhs,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
 SharhDesc,fldIsExternal,fldDaramadGroupId
 FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
			ELSE N'0'END AS fldStatusFish
			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
			ELSE N'0' end AS fldStatusTaghsit,
		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
			 AS fldStatusTakhfif,
			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
			THEN N'2'ELSE '0'END AS*/'0' fldStatusKoli,
                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
                       FROM      Com.tblAshkhas
                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
FROM     Drd.tblElamAvarez)t
	WHERE  fldId = @Value and t.fldOrganId=@Value1
	ORDER BY fldid DESC
	
		
	end
--	else if (@fieldname=N'fldMablaghKoli')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS*/'0' fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldMablaghKoli like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
	
--	end
--else if (@fieldname=N'SharhDesc')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS */'0' fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  SharhDesc like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end
--		else if (@fieldname=N'fldMablaghTakhfif')
--		begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldMablaghTakhfif like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end
--	else if (@fieldname=N'fldMablaghGHabelPardakht')
--	begin
--SELECT TOP (@h) * FROM (SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
--CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- ,SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	)r
--	WHERE fldMablaghGHabelPardakht like @value and r.fldOrganId=@Value1
--	ORDER BY fldid DESC
	
--	end
--	else if (@fieldname=N'fldNameShakhs')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
--CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- ,SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldNameShakhs like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end
--	else IF (@fieldname=N'fldShenaseMeli')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
--CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- ,SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldShenaseMeli like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end

	
--	else IF (@fieldname=N'Noe')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
--CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- ,SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  Noe like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end
--	else IF (@fieldname=N'fldNoeShakhs')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS*/'0' fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldNoeShakhs like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC
--	end


--	else IF (@fieldname=N'fldTarikh')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			/*CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS*/'0' fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, com.MiladiTOShamsi(fldDate) fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  fldTarikh like @Value and t.fldOrganId=@Value1
--	ORDER BY fldid DESC

--	end

--		else if (@fieldname=N'fldAshakhasID')
--		begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--WHERE  fldAshakhasID = @Value and t.fldOrganId=@Value1

--end
--		else if (@fieldname=N'CheckAshakhasID')
--		begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
--CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- ,SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--WHERE  fldAshakhasID = @Value 

--end
--	else 	if (@fieldname=N'fldDesc')
--	begin
--SELECT TOP (@h) fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate ,Noe,fldNameShakhs,fldShenaseMeli
--  ,fldNoeShakhs,fldTarikh,isnull(fldFather_Sabt,'')fldFather_Sabt,fldOrganId,fldReplyTaghsitId,fldMablaghKoli,fldMablaghTakhfif,ISNULL((fldMablaghKoli-fldMablaghTakhfif),0) AS fldMablaghGHabelPardakht
--,fldStatusFish,fldStatusTakhfif,fldStatusTaghsit,fldStatusKoli,fldNameOrgan,
--CASE WHEN fldStatusFish=N'0' then N'فیشی صادر نشده'  WHEN fldStatusFish=N'1' then N'کلیه فیش های صادرشده'  WHEN fldStatusFish=N'2' then N'فیش صادر شده'  WHEN fldStatusFish=N'3' then N'ابطال فیش' WHEN fldStatusFish=N'4' then N'ابطال کلیه فیش ها' end as fldStatusFishName,
--CASE WHEN fldStatusTakhfif=N'0' then N'درخواست تخفیف صادر نشده'  WHEN fldStatusTakhfif=N'1' THEN N'موافقت شده' WHEN fldStatusTakhfif=N'2' THEN N'عدم موافقت' WHEN fldStatusTakhfif=N'3' THEN N'ابطال شده' WHEN fldStatusTakhfif=N'4' THEN N'درخواست تخفیف' end as fldStatusTakhfifName ,
--CASE WHEN fldStatusTaghsit=N'0' then N'درخواست تقسیط صادرنشده' WHEN fldStatusTaghsit=N'1' then N'موافقت شده' WHEN fldStatusTaghsit=N'2' then N'عدم موافقت' WHEN fldStatusTaghsit=N'3' then N'ابطال شده' WHEN fldStatusTaghsit=N'4' then N'درخواست تقسیط' end as  fldStatusTaghsitName,
----CASE WHEN fldStatusKoli='1' THEN N'تسویه نقدی'  WHEN fldStatusKoli='2' THEN N'تسویه تقسیط' ELSE N'تسویه نشده' END AS fldStatusKoliName 
-- SharhDesc,fldIsExternal,fldDaramadGroupId
-- FROM(SELECT fldId, fldAshakhasID, fldType, fldUserId, fldDesc, fldDate, CASE WHEN fldIsExternal = 0 THEN N'داخلی' WHEN fldIsExternal = 1 THEN N'متفرقه' else '' END AS Noe, 
--                  Com.fn_NameAshkhasHaghighi_Hoghoghi(fldAshakhasID) AS fldNameShakhs, Com.fn_ShenaseMelliAshkhas(fldAshakhasID) AS fldShenaseMeli, 
--            CASE WHEN (SELECT COUNT(*) FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId HAVING COUNT(fldid)>0)=(SELECT COUNT(fldFishId) FROM Drd.tblEbtal WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)HAVING COUNT(fldFishId)>0) THEN N'4'
--			WHEN (SELECT TOP(1) fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId ORDER BY fldId desc )  IN (SELECT fldFishId FROM Drd.tblEbtal ) THEN N'3'
--			WHEN (SELECT COUNT(*) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)=(SELECT COUNT(id) FROM ( SELECT MAX(fldId) AS id FROM Drd.tblSodoorFish_Detail WHERE fldFishId IN (SELECT fldId FROM Drd.tblSodoorFish WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId) GROUP BY fldCodeElamAvarezId)t) THEN N'1'
--			WHEN EXISTS(SELECT * FROM Drd.tblSodoorFish_Detail WHERE fldCodeElamAvarezId IN (SELECT fldid FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)) THEN N'2'
--			ELSE N'0'END AS fldStatusFish
--			,CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1) THEN N'4' 
--			ELSE N'0' end AS fldStatusTaghsit,
--		     CASE WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'1'
--			WHEN (fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=2 AND fldTypeMojavez=2 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)) THEN N'2'
--			WHEN fldid in (SELECT TOP(1)  CASE WHEN fldid IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)  THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2 ORDER BY tblRequestTaghsit_Takhfif.fldId desc) THEN N'3'
--			WHEN EXISTS (SELECT * FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=2) THEN N'4' ELSE N'0' END
--			 AS fldStatusTakhfif,
--			CASE WHEN ((SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus=2 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId)))))
--			)OR ((SELECT (SUM(((fldAsliValue*fldTedad)+fldMaliyatValue+fldAvarezValue)) /(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId AND fldMablaghGerdKardan<>0))*(SELECT fldMablaghGerdKardan FROM Drd.tblTanzimateDaramad WHERE tblTanzimateDaramad.fldOrganId=Drd.tblElamAvarez.fldOrganId) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT SUM(fldMablaghAvarezGerdShode) FROM Drd.tblSodoorFish WHERE fldid IN (SELECT fldFishId FROM Drd.tblSodoorFish_Detail WHERE fldFishId=Drd.tblSodoorFish.fldId)AND fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldid NOT IN (SELECT fldFishId FROM Drd.tblEbtal WHERE fldFishId=Drd.tblSodoorFish.fldId)) ) THEN N'1'
--			WHEN (SELECT  sum(cast(cast(fldAsliValue as bigint)*cast(fldtedad as bigint)+cast(fldMaliyatValue as bigint)+cast(fldAvarezValue as bigint)as bigint)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId)
--			=(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblCheck WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblSafte WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablaghSanad as bigint)),0) FROM Drd.tblBarat WHERE fldStatus<>5 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			+(SELECT isnull(SUM(cast(fldMablagh as bigint)),0) FROM Drd.tblNaghdi_Talab WHERE fldType=0 AND fldReplyTaghsitId IN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT  fldid FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT fldId FROM Drd.tblRequestTaghsit_Takhfif WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId))))
--			THEN N'2'ELSE '0'END AS fldStatusKoli,
--                     (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN '0' WHEN fldHoghoghiId IS NOT NULL THEN '1' END AS Expr1
--                       FROM      Com.tblAshkhas
--                       WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldNoeShakhs, fldTarikh,
--                      (SELECT CASE WHEN fldHaghighiId IS NOT NULL THEN(SELECT fldFatherName FROM  Com.tblEmployee_Detail WHERE   fldEmployeeId = fldHaghighiId) WHEN fldHoghoghiId IS NOT NULL THEN
--                      (SELECT fldShomareSabt FROM      Com.tblAshkhaseHoghoghi WHERE   fldid = fldHoghoghiId) END AS Expr1 FROM Com.tblAshkhas AS tblAshkhas_1 WHERE   (fldId = Drd.tblElamAvarez.fldAshakhasID)) AS fldFather_Sabt, fldOrganId
--                      ,ISNULL(CASE WHEN fldid IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) AND fldid IN (SELECT fldRequestId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldTypeRequest=1 AND fldTypeMojavez=1 AND fldRequestId=Drd.tblRequestTaghsit_Takhfif.fldId ) THEN fldElamAvarezId ELSE 0 end  FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc)
--                      THEN (SELECT fldId FROM Drd.tblReplyTaghsit WHERE fldStatusId IN (SELECT fldId FROM Drd.tblStatusTaghsit_Takhfif WHERE fldRequestId IN (SELECT TOP(1)  CASE WHEN fldid NOT IN (SELECT fldRequestTaghsit_TakhfifId FROM Drd.tblEbtal WHERE fldRequestTaghsit_TakhfifId=Drd.tblRequestTaghsit_Takhfif.fldId) THEN fldId ELSE 0 END FROM Drd.tblRequestTaghsit_Takhfif WHERE   fldElamAvarezId=Drd.tblElamAvarez.fldId AND fldRequestType=1 ORDER BY tblRequestTaghsit_Takhfif.fldId desc))) ELSE 0 END,0) fldReplyTaghsitId
--                      ,isnull((SELECT SUM((fldMaliyatValue+(fldAsliValue*fldTedad)+fldAvarezValue)) FROM Drd.tblCodhayeDaramadiElamAvarez WHERE fldElamAvarezId=Drd.tblElamAvarez.fldId),0) fldMablaghKoli,
--						ISNULL(cast(drd.Fn_MablaghTakhfif('MablaghTakhfif_ElamAvarez',fldId) AS BIGINT),CAST(0 AS BIGINT)) AS fldMablaghTakhfif
--						,(SELECT com.fn_stringDecode(fldName) FROM Com.tblOrganization WHERE fldid=Drd.tblElamAvarez.fldOrganId)AS fldNameOrgan
--,drd.fn_SharheCode_ElamAvarez(fldid) AS SharhDesc,fldIsExternal,fldDaramadGroupId
--FROM     Drd.tblElamAvarez)t
--	WHERE  t.fldDesc like @Value and t.fldOrganId=@Value1
	
--	end

	
	COMMIT
GO
